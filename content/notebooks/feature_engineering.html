
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Feature engineering for electricity load forecasting &#8212; Forecasting with machine learning</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/notebooks/feature_engineering';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Direct vs Recursive Forecasting" href="direct_vs_recursive_forecasting.html" />
    <link rel="prev" title="Historical weather data download from open-meteo.com" href="fetch_weather_data.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.svg" class="logo__image only-light" alt="Forecasting with machine learning - Home"/>
    <script>document.write(`<img src="../../_static/logo.svg" class="logo__image only-dark" alt="Forecasting with machine learning - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Forecasting with machine learning
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Forecasting with Machine Learning</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="fetch_weather_data.html">Historical weather data download from open-meteo.com</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Feature engineering for electricity load forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="direct_vs_recursive_forecasting.html">Direct vs Recursive Forecasting</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/probabl-ai/forecasting" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/probabl-ai/forecasting/issues/new?title=Issue%20on%20page%20%2Fcontent/notebooks/feature_engineering.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/notebooks/feature_engineering.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Feature engineering for electricity load forecasting</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shared-time-range-for-all-historical-data-sources">Shared time range for all historical data sources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calendar-and-holidays-features">Calendar and holidays features</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#electricity-load-data">Electricity load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lagged-features">Lagged features</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remark-lagged-features-engineering-and-system-lag">Remark lagged features engineering and system lag</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#investigating-outliers-in-the-lagged-features">Investigating outliers in the lagged features</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-dataset">Final dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-the-model-performance-via-cross-validation">Assessing the model performance via cross-validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-non-linear-feature-engineering-coupled-with-linear-predictive-model">Exercise: non-linear feature engineering coupled with linear predictive model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#predicting-multiple-horizons-with-a-multi-output-model">Predicting multiple horizons with a multi-output model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reliability-diagram-for-quantile-regression">Reliability diagram for quantile regression</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantile-regression-as-classification">Quantile regression as classification</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="feature-engineering-for-electricity-load-forecasting">
<h1>Feature engineering for electricity load forecasting<a class="headerlink" href="#feature-engineering-for-electricity-load-forecasting" title="Link to this heading">#</a></h1>
<p>The purpose of this notebook is to demonstrate how to use <code class="docutils literal notranslate"><span class="pre">skrub</span></code> and
<code class="docutils literal notranslate"><span class="pre">polars</span></code> to perform feature engineering for electricity load forecasting.</p>
<p>We will build a set of features (and targets) from different data sources:</p>
<ul class="simple">
<li><p>Historical weather data for 10 medium to large urban areas in France;</p></li>
<li><p>Holidays and standard calendar features for France;</p></li>
<li><p>Historical electricity load data for the whole of France.</p></li>
</ul>
<p>All these data sources cover a time range from March 23, 2021 to May 31,
2025.</p>
<p>Since our maximum forecasting horizon is 24 hours, we consider that the
future weather data is known at a chosen prediction time. Similarly, the
holidays and calendar features are known at prediction time for any point in
the future.</p>
<p>Therefore, exogenous features derived from the weather and calendar data can
be used to engineer “future covariates”. Since the load data is our
prediction target, we will can also use it to engineer “past covariates” such
as lagged features and rolling aggregations. The future values of the load
data (with respect to the prediction time) are used as targets for the
forecasting model.</p>
<section id="environment-setup">
<h2>Environment setup<a class="headerlink" href="#environment-setup" title="Link to this heading">#</a></h2>
<p>We need to install some extra dependencies for this notebook if needed (when
running jupyterlite). We need the development version of skrub to be able to
use the skrub expressions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> install -q https://pypi.anaconda.org/ogrisel/simple/polars/1.24.0/polars-1.24.0-cp39-abi3-emscripten_3_1_58_wasm32.whl
<span class="o">%</span><span class="k">pip</span> install -q https://pypi.anaconda.org/ogrisel/simple/skrub/0.6.dev0/skrub-0.6.dev0-py3-none-any.whl
<span class="o">%</span><span class="k">pip</span> install -q altair holidays plotly nbformat
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">ERROR: polars-1.24.0-cp39-abi3-emscripten_3_1_58_wasm32.whl is not a supported wheel on this platform.</span>

</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
</div>
</div>
<p>The following 3 imports are only needed to workaround some limitations when
using polars in a pyodide/jupyterlite notebook.</p>
<p>TODO: remove those workarounds once pyodide 0.28 is released with support for
the latest polars version.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tzdata</span>  <span class="c1"># noqa: F401</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_table</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">altair</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">skrub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">holidays</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tutorial_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">plot_lorenz_curve</span><span class="p">,</span>
    <span class="n">plot_reliability_diagram</span><span class="p">,</span>
    <span class="n">plot_residuals_vs_predicted</span><span class="p">,</span>
    <span class="n">plot_binned_residuals</span><span class="p">,</span>
    <span class="n">plot_horizon_forecast</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Ignore warnings from pkg_resources triggered by Python 3.13&#39;s multiprocessing.</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;pkg_resources&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">14</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="kn">import</span><span class="w"> </span><span class="nn">holidays</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="ne">---&gt; </span><span class="mi">14</span> <span class="kn">from</span><span class="w"> </span><span class="nn">tutorial_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="n">plot_lorenz_curve</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span>     <span class="n">plot_reliability_diagram</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="n">plot_residuals_vs_predicted</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>     <span class="n">plot_binned_residuals</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span>     <span class="n">plot_horizon_forecast</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="c1"># Ignore warnings from pkg_resources triggered by Python 3.13&#39;s multiprocessing.</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span> <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;pkg_resources&quot;</span><span class="p">)</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;tutorial_helpers&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="shared-time-range-for-all-historical-data-sources">
<h2>Shared time range for all historical data sources<a class="headerlink" href="#shared-time-range-for-all-historical-data-sources" title="Link to this heading">#</a></h2>
<p>Let’s define a hourly time range from March 23, 2021 to May 31, 2025 that
will be used to join the electricity load data and the weather data. The time
range is in UTC timezone to avoid any ambiguity when joining with the weather
data that is also in UTC.</p>
<p>We wrap the resulting polars dataframe in a <code class="docutils literal notranslate"><span class="pre">skrub</span></code> expression to benefit
from the built-in <code class="docutils literal notranslate"><span class="pre">skrub.TableReport</span></code> display in the notebook. Using the
<code class="docutils literal notranslate"><span class="pre">skrub</span></code> expression system will also be useful for other reasons: all
operations in this notebook chain operations chained together in a directed
acyclic graph that is automatically tracked by <code class="docutils literal notranslate"><span class="pre">skrub</span></code>. This allows us to
extract the resulting pipeline and apply it to new data later on, exactly
like a trained scikit-learn pipeline. The main difference is that we do so
incrementally and while eagerly executing and inspecting the results of each
step as is customary when working with dataframe libraries such as polars and
pandas in Jupyter notebooks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">historical_data_start_time</span> <span class="o">=</span> <span class="n">skrub</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
    <span class="s2">&quot;historical_data_start_time&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">historical_data_end_time</span> <span class="o">=</span> <span class="n">skrub</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
    <span class="s2">&quot;historical_data_end_time&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@skrub</span><span class="o">.</span><span class="n">deferred</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_historical_time_range</span><span class="p">(</span>
    <span class="n">historical_data_start_time</span><span class="p">,</span>
    <span class="n">historical_data_end_time</span><span class="p">,</span>
    <span class="n">time_interval</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span><span class="p">,</span>
    <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define an historical time range shared by all data sources.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">datetime_range</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">historical_data_start_time</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="n">historical_data_end_time</span><span class="p">,</span>
            <span class="n">time_zone</span><span class="o">=</span><span class="n">time_zone</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
    <span class="p">)</span>


<span class="n">time</span> <span class="o">=</span> <span class="n">build_historical_time_range</span><span class="p">(</span><span class="n">historical_data_start_time</span><span class="p">,</span> <span class="n">historical_data_end_time</span><span class="p">)</span>
<span class="n">time</span>
</pre></div>
</div>
</div>
</div>
<p>If you run the above locally with pydot and graphviz installed, you can
visualize the expression graph of the <code class="docutils literal notranslate"><span class="pre">time</span></code> variable by expanding the “Show
graph” button.</p>
<p>Let’s now load the data records for the time range defined above.</p>
<p>To avoid network issues when running this notebook, the necessary data files
have already been downloaded and saved in the <code class="docutils literal notranslate"><span class="pre">datasets</span></code> folder. See the
<a class="reference external" href="http://README.md">README.md</a> file for instructions to download the data manually if you want to
re-run this notebook with more recent data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_source_folder</span> <span class="o">=</span> <span class="n">skrub</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;data_source_folder&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;../datasets&quot;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_source_folder</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We define a list of 10 medium to large urban areas to approximately cover
most regions in France with a slight focus on most populated regions that are
likely to drive electricity demand.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">city_names</span> <span class="o">=</span> <span class="n">skrub</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
    <span class="s2">&quot;city_names&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="s2">&quot;paris&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lyon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;marseille&quot;</span><span class="p">,</span>
        <span class="s2">&quot;toulouse&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lille&quot;</span><span class="p">,</span>
        <span class="s2">&quot;limoges&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nantes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;strasbourg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;brest&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bayonne&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>


<span class="nd">@skrub</span><span class="o">.</span><span class="n">deferred</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_weather_data</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">city_names</span><span class="p">,</span> <span class="n">data_source_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and horizontal stack historical weather forecast data for each city.&quot;&quot;&quot;</span>
    <span class="n">all_city_weather</span> <span class="o">=</span> <span class="n">time</span>
    <span class="k">for</span> <span class="n">city_name</span> <span class="ow">in</span> <span class="n">city_names</span><span class="p">:</span>
        <span class="n">all_city_weather</span> <span class="o">=</span> <span class="n">all_city_weather</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">from_arrow</span><span class="p">(</span>
                <span class="n">read_table</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_source_folder</span><span class="si">}</span><span class="s2">/weather_</span><span class="si">{</span><span class="n">city_name</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">cast_time_unit</span><span class="p">(</span><span class="s2">&quot;us&quot;</span><span class="p">)])</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span> <span class="k">else</span> <span class="s2">&quot;weather_&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">city_name</span><span class="p">),</span>
            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">all_city_weather</span>


<span class="n">all_city_weather</span> <span class="o">=</span> <span class="n">load_weather_data</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">city_names</span><span class="p">,</span> <span class="n">data_source_folder</span><span class="p">)</span>
<span class="n">all_city_weather</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calendar-and-holidays-features">
<h2>Calendar and holidays features<a class="headerlink" href="#calendar-and-holidays-features" title="Link to this heading">#</a></h2>
<p>We leverage the <code class="docutils literal notranslate"><span class="pre">holidays</span></code> package to enrich the time range with some
calendar features such as public holidays in France. We also add some
features that are useful for time series forecasting such as the day of the
week, the day of the year, and the hour of the day.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">holidays</span></code> package requires us to extract the date for the
French timezone.</p>
<p>Similarly for the calendar features: all the time features are extracted from
the time in the French timezone, since it is likely that electricity usage
patterns are influenced by inhabitants’ daily routines aligned with the local
timezone.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@skrub</span><span class="o">.</span><span class="n">deferred</span>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_french_calendar_data</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
    <span class="n">fr_time</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">convert_time_zone</span><span class="p">(</span><span class="s2">&quot;Europe/Paris&quot;</span><span class="p">)</span>
    <span class="n">fr_year_min</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fr_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">fr_year_max</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fr_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">holidays_fr</span> <span class="o">=</span> <span class="n">holidays</span><span class="o">.</span><span class="n">country_holidays</span><span class="p">(</span>
        <span class="s2">&quot;FR&quot;</span><span class="p">,</span> <span class="n">years</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">fr_year_min</span><span class="p">,</span> <span class="n">fr_year_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">fr_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cal_hour_of_day&quot;</span><span class="p">),</span>
            <span class="n">fr_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cal_day_of_week&quot;</span><span class="p">),</span>
            <span class="n">fr_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">ordinal_day</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cal_day_of_year&quot;</span><span class="p">),</span>
            <span class="n">fr_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cal_year&quot;</span><span class="p">),</span>
            <span class="n">fr_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">holidays_fr</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cal_is_holiday&quot;</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>


<span class="n">calendar</span> <span class="o">=</span> <span class="n">prepare_french_calendar_data</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
<span class="n">calendar</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="electricity-load-data">
<h2>Electricity load data<a class="headerlink" href="#electricity-load-data" title="Link to this heading">#</a></h2>
<p>Finally we load the electricity load data. This data will both be used as a
target variable but also to craft some lagged and window-aggregated features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@skrub</span><span class="o">.</span><span class="n">deferred</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_electricity_load_data</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data_source_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and aggregate historical load data from the raw CSV files.&quot;&quot;&quot;</span>
    <span class="n">load_data_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">data_file</span>
        <span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_source_folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">data_file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Total Load - Day Ahead&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">data_file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                        <span class="p">[</span><span class="s2">&quot;Day-ahead Total Load Forecast [MW] - BZN|FR&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">load_data_files</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Time (UTC)&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot; - &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m.%Y %H:%M&quot;</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Actual Total Load [MW] - BZN|FR&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">electricity</span> <span class="o">=</span> <span class="n">load_electricity_load_data</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data_source_folder</span><span class="p">)</span>
<span class="n">electricity</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">electricity</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">electricity</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
<span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;time:T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;load_mw:Q&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">electricity</span> <span class="o">=</span> <span class="n">electricity</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()])</span>
<span class="n">electricity</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
<span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;time:T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;load_mw:Q&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="lagged-features">
<h2>Lagged features<a class="headerlink" href="#lagged-features" title="Link to this heading">#</a></h2>
<p>We can now create some lagged features from the electricity load data.</p>
<p>We will create 3 hourly lagged features, 1 daily lagged feature, and 1 weekly
lagged feature. We will also create a rolling median and inter-quartile
feature over the last 24 hours and over the last 7 days.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">iqr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inter-quartile range (IQR) of a column.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">col</span><span class="o">.</span><span class="n">rolling_quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span> <span class="o">-</span> <span class="n">col</span><span class="o">.</span><span class="n">rolling_quantile</span><span class="p">(</span>
        <span class="mf">0.25</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span>
    <span class="p">)</span>


<span class="n">electricity_lagged</span> <span class="o">=</span> <span class="n">electricity</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_mw_lag_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">h&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
    <span class="o">+</span> <span class="p">[</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;load_mw_lag_1d&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;load_mw_lag_1w&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rolling_median</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;load_mw_rolling_median_24h&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rolling_median</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;load_mw_rolling_median_7d&quot;</span><span class="p">),</span>
        <span class="n">iqr</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">),</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;load_mw_iqr_24h&quot;</span><span class="p">),</span>
        <span class="n">iqr</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">),</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;load_mw_iqr_7d&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="n">electricity_lagged</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">electricity_lagged</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span><span class="o">.</span><span class="n">transform_fold</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;load_mw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_lag_1h&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_lag_2h&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_lag_3h&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_lag_1d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_lag_1w&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_rolling_median_24h&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_rolling_median_7d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_rolling_iqr_24h&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_rolling_iqr_7d&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">as_</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;load_mw&quot;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span><span class="n">tooltip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;time:T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;load_mw:Q&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;key:N&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="remark-lagged-features-engineering-and-system-lag">
<h2>Remark lagged features engineering and system lag<a class="headerlink" href="#remark-lagged-features-engineering-and-system-lag" title="Link to this heading">#</a></h2>
<p>When working with historical data, we often have access to all the past
measurements in the dataset. However, when we want to use the lagged features
in a forecasting model, we need to be careful about the length of the
<strong>system lag</strong>: the time between a timestamped measurement is made in the
real world and the time the record is made available to the downstream
application (in our case, a deployed predictive pipeline).</p>
<p>System lag is rarely explicitly represented in the data sources even if such
delay can be as large as several hours or even days and can sometimes be
irregular. For instance, if there is a human intervention in the data
recording process, holidays and weekends can punctually add significant
delay.</p>
<p>If the system lag is larger than the maximum feature engineering lag, the
resulting features be filled with missing values once deployed. More
importantly, if the system lag is not handled explicitly, those resulting
missing values will only be present in the features computed for the
deployed system but not present in the features computed to train and
backtest the system before deployment.</p>
<p>This structural discrepancy can severely degrade the performance of the
deployed model compared to the performance estimated from backtesting on the
historical data.</p>
<p>We will set this problem aside for now but discuss it again in a later
section of this tutorial.</p>
</section>
<section id="investigating-outliers-in-the-lagged-features">
<h2>Investigating outliers in the lagged features<a class="headerlink" href="#investigating-outliers-in-the-lagged-features" title="Link to this heading">#</a></h2>
<p>Let’s use the <code class="docutils literal notranslate"><span class="pre">skrub.TableReport</span></code> tool to look at the plots of the marginal
distribution of the lagged features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">skrub</span><span class="w"> </span><span class="kn">import</span> <span class="n">TableReport</span>

<span class="n">TableReport</span><span class="p">(</span><span class="n">electricity_lagged</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s extract the dates where the inter-quartile range of the load is
greater than 15,000 MW.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">electricity_lagged</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw_iqr_7d&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15_000</span><span class="p">)[</span>
    <span class="s2">&quot;time&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We observe 3 date ranges with high inter-quartile range. Let’s plot the
electricity load and the lagged features for the first data range along with
the weather data for Paris.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span>
    <span class="n">electricity_lagged</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
    <span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="p">)</span><span class="o">.</span><span class="n">transform_fold</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;load_mw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_mw_iqr_7d&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;time:T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value:Q&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;key:N&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span>
    <span class="n">all_city_weather</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
    <span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="p">)</span><span class="o">.</span><span class="n">transform_fold</span><span class="p">(</span>
    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;weather_temperature_2m_</span><span class="si">{</span><span class="n">city_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">city_name</span> <span class="ow">in</span> <span class="n">city_names</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()],</span>
<span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;time:T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value:Q&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;key:N&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Based on the plots above, we can see that the electricity load was high just
before the Christmas holidays due to low temperatures. Then the load suddenly
dropped because temperatures went higher right at the start of the
end-of-year holidays.</p>
<p>So those outliers do not seem to be caused to a data quality issue but rather
due to a real change in the electricity load demand. We could conduct similar
analysis for the other date ranges with high inter-quartile range but we will
skip that for now.</p>
<p>If we had observed significant data quality issues over extended periods of
time could have been addressed by removing the corresponding rows from the
dataset. However, this would make the lagged and windowing feature
engineering challenging to reimplement correctly. A better approach would be
to keep a contiguous dataset assign 0 weights to the affected rows when
fitting or evaluating the trained models via the use of the <code class="docutils literal notranslate"><span class="pre">sample_weight</span></code>
parameter.</p>
</section>
<section id="final-dataset">
<h2>Final dataset<a class="headerlink" href="#final-dataset" title="Link to this heading">#</a></h2>
<p>We now assemble the dataset that will be used to train and evaluate the forecasting
models via backtesting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prediction_start_time</span> <span class="o">=</span> <span class="n">skrub</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
    <span class="s2">&quot;prediction_start_time&quot;</span><span class="p">,</span> <span class="n">historical_data_start_time</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">duration</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">prediction_end_time</span> <span class="o">=</span> <span class="n">skrub</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
    <span class="s2">&quot;prediction_end_time&quot;</span><span class="p">,</span> <span class="n">historical_data_end_time</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">duration</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="p">)</span>


<span class="nd">@skrub</span><span class="o">.</span><span class="n">deferred</span>
<span class="k">def</span><span class="w"> </span><span class="nf">define_prediction_time_range</span><span class="p">(</span><span class="n">prediction_start_time</span><span class="p">,</span> <span class="n">prediction_end_time</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">datetime_range</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">prediction_start_time</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="n">prediction_end_time</span><span class="p">,</span>
            <span class="n">time_zone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">),</span>
    <span class="p">)</span>


<span class="n">prediction_time</span> <span class="o">=</span> <span class="n">define_prediction_time_range</span><span class="p">(</span>
    <span class="n">prediction_start_time</span><span class="p">,</span> <span class="n">prediction_end_time</span>
<span class="p">)</span>
<span class="n">prediction_time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@skrub</span><span class="o">.</span><span class="n">deferred</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_features</span><span class="p">(</span>
    <span class="n">prediction_time</span><span class="p">,</span>
    <span class="n">electricity_lagged</span><span class="p">,</span>
    <span class="n">all_city_weather</span><span class="p">,</span>
    <span class="n">calendar</span><span class="p">,</span>
    <span class="n">future_feature_horizons</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span>
<span class="p">):</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">prediction_time</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">electricity_lagged</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">all_city_weather</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)]</span>
                <span class="o">+</span> <span class="p">[</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_future_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">h&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_city_weather</span><span class="o">.</span><span class="n">columns</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;time&quot;</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">future_feature_horizons</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">calendar</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)]</span>
                <span class="o">+</span> <span class="p">[</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_future_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">h&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calendar</span><span class="o">.</span><span class="n">columns</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;time&quot;</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">future_feature_horizons</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">)</span>


<span class="n">features</span> <span class="o">=</span> <span class="n">build_features</span><span class="p">(</span>
    <span class="n">prediction_time</span><span class="o">=</span><span class="n">prediction_time</span><span class="p">,</span>
    <span class="n">electricity_lagged</span><span class="o">=</span><span class="n">electricity_lagged</span><span class="p">,</span>
    <span class="n">all_city_weather</span><span class="o">=</span><span class="n">all_city_weather</span><span class="p">,</span>
    <span class="n">calendar</span><span class="o">=</span><span class="n">calendar</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">mark_as_X</span><span class="p">()</span>

<span class="n">features</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s build training and evaluation targets for all possible horizons from 1
to 24 hours.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">horizons</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">target_column_name_pattern</span> <span class="o">=</span> <span class="s2">&quot;load_mw_horizon_</span><span class="si">{horizon}</span><span class="s2">h&quot;</span>


<span class="nd">@skrub</span><span class="o">.</span><span class="n">deferred</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_targets</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">,</span> <span class="n">electricity</span><span class="p">,</span> <span class="n">horizons</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">prediction_time</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">electricity</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;load_mw&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">)</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">target_column_name_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="n">h</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">horizons</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">targets</span> <span class="o">=</span> <span class="n">build_targets</span><span class="p">(</span><span class="n">prediction_time</span><span class="p">,</span> <span class="n">electricity</span><span class="p">,</span> <span class="n">horizons</span><span class="p">)</span>
<span class="n">targets</span>
</pre></div>
</div>
</div>
</div>
<p>For now, let’s focus on the last horizon (24 hours) to train a model
predicting the electricity load at the next 24 hours.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">horizon_of_interest</span> <span class="o">=</span> <span class="n">horizons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Focus on the 24-hour horizon</span>
<span class="n">target_column_name</span> <span class="o">=</span> <span class="n">target_column_name_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="n">horizon_of_interest</span><span class="p">)</span>
<span class="n">predicted_target_column_name</span> <span class="o">=</span> <span class="s2">&quot;predicted_&quot;</span> <span class="o">+</span> <span class="n">target_column_name</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">target_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">mark_as_y</span><span class="p">()</span>
<span class="n">target</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s define our first single output prediction pipeline. This pipeline
chains our previous feature engineering steps with a <code class="docutils literal notranslate"><span class="pre">skrub.DropCols</span></code> step to
drop some columns that we do not want to use as features, and a
<code class="docutils literal notranslate"><span class="pre">HistGradientBoostingRegressor</span></code> model from scikit-learn.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">skrub.choose_from</span></code>, <code class="docutils literal notranslate"><span class="pre">skrub.choose_float</span></code>, and <code class="docutils literal notranslate"><span class="pre">skrub.choose_int</span></code>
functions are used to define hyperparameters that can be tuned via
cross-validated randomized search.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">HistGradientBoostingRegressor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">skrub.selectors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">s</span>


<span class="n">features_with_dropped_cols</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">skrub</span><span class="o">.</span><span class="n">DropCols</span><span class="p">(</span>
        <span class="n">cols</span><span class="o">=</span><span class="n">skrub</span><span class="o">.</span><span class="n">choose_from</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span>  <span class="c1"># No column has an empty name.</span>
                <span class="s2">&quot;load&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;load_*&quot;</span><span class="p">),</span>
                <span class="s2">&quot;rolling_load&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;load_mw_rolling_*&quot;</span><span class="p">),</span>
                <span class="s2">&quot;weather&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;weather_*&quot;</span><span class="p">),</span>
                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;weather_temperature_*&quot;</span><span class="p">),</span>
                <span class="s2">&quot;moisture&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;weather_moisture_*&quot;</span><span class="p">),</span>
                <span class="s2">&quot;cloud_cover&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;weather_cloud_cover_*&quot;</span><span class="p">),</span>
                <span class="s2">&quot;calendar&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;cal_*&quot;</span><span class="p">),</span>
                <span class="s2">&quot;holiday&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;cal_is_holiday*&quot;</span><span class="p">),</span>
                <span class="s2">&quot;future_1h&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_future_1h&quot;</span><span class="p">),</span>
                <span class="s2">&quot;future_24h&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_future_24h&quot;</span><span class="p">),</span>
                <span class="s2">&quot;non_paris_weather&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;weather_*&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">s</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;weather_*_paris_*&quot;</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dropped_cols&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">hgbr_predictions</span> <span class="o">=</span> <span class="n">features_with_dropped_cols</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">skrub</span><span class="o">.</span><span class="n">choose_from</span><span class="p">([</span><span class="s2">&quot;squared_error&quot;</span><span class="p">,</span> <span class="s2">&quot;poisson&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">),</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="n">skrub</span><span class="o">.</span><span class="n">choose_float</span><span class="p">(</span>
            <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;learning_rate&quot;</span>
        <span class="p">),</span>
        <span class="n">max_leaf_nodes</span><span class="o">=</span><span class="n">skrub</span><span class="o">.</span><span class="n">choose_int</span><span class="p">(</span>
            <span class="mi">3</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;max_leaf_nodes&quot;</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">hgbr_predictions</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">predictions</span></code> expression captures the whole expression graph that
includes the feature engineering steps, the target variable, and the model
training step.</p>
<p>In particular, the input data keys for the full pipeline can be
inspected as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hgbr_predictions</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Furthermore, the hyper-parameters of the full pipeline can be retrieved as
follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hgbr_pipeline</span> <span class="o">=</span> <span class="n">hgbr_predictions</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">get_pipeline</span><span class="p">()</span>
<span class="n">hgbr_pipeline</span><span class="o">.</span><span class="n">describe_params</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>When running this notebook locally, you can also interactively inspect all
the steps of the DAG using the following (once uncommented):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># predictions.skb.full_report()</span>
</pre></div>
</div>
</div>
</div>
<p>Since we passed input values to all the upstream <code class="docutils literal notranslate"><span class="pre">skrub</span></code> variables, <code class="docutils literal notranslate"><span class="pre">skrub</span></code>
automatically evaluates the whole expression graph graph (train and predict
on the same data) so that we can interactively check that everything will
work as expected.</p>
<p>Let’s use altair to visualize the predictions against the target values for
the last 24 hours of the prediction time range used to train the model. This
allows us can (over)fit the data with the features at hand.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">targets</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
            <span class="n">hgbr_predictions</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="p">{</span><span class="n">target_column_name</span><span class="p">:</span> <span class="n">predicted_target_column_name</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
        <span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">transform_fold</span><span class="p">(</span>
    <span class="p">[</span><span class="n">target_column_name</span><span class="p">,</span> <span class="n">predicted_target_column_name</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;prediction_time:T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value:Q&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;key:N&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="assessing-the-model-performance-via-cross-validation">
<h2>Assessing the model performance via cross-validation<a class="headerlink" href="#assessing-the-model-performance-via-cross-validation" title="Link to this heading">#</a></h2>
<p>Being able to fit the training data is not enough. We need to assess the
ability of the training pipeline to learn a predictive model that can
generalize to unseen data.</p>
<p>Furthermore, we want to assess the uncertainty of this estimate of the
generalization performance via time-based cross-validation, also known as
backtesting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesSplit</span>


<span class="n">max_train_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">52</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span>  <span class="c1"># max ~2 years of training data</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span>  <span class="c1"># 24 weeks of test data</span>
<span class="n">gap</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span>  <span class="c1"># 1 week gap between train and test sets</span>
<span class="n">ts_cv_5</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span>
    <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_train_size</span><span class="o">=</span><span class="n">max_train_size</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="n">gap</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">fold_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="n">ts_cv_5</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prediction_time</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CV iteration #</span><span class="si">{</span><span class="n">fold_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">train_datetimes</span> <span class="o">=</span> <span class="n">prediction_time</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()[</span><span class="n">train_idx</span><span class="p">]</span>
    <span class="n">test_datetimes</span> <span class="o">=</span> <span class="n">prediction_time</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()[</span><span class="n">test_idx</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Train: </span><span class="si">{</span><span class="n">train_datetimes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> rows, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Test: </span><span class="si">{</span><span class="n">test_datetimes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> rows&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train time range: </span><span class="si">{</span><span class="n">train_datetimes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">train_datetimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test time range: </span><span class="si">{</span><span class="n">test_datetimes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">test_datetimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_scorer</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span><span class="p">,</span> <span class="n">get_scorer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">d2_tweedie_score</span>


<span class="n">hgbr_cv_results</span> <span class="o">=</span> <span class="n">hgbr_predictions</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_5</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;mape&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">mean_absolute_percentage_error</span><span class="p">),</span>
        <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="n">get_scorer</span><span class="p">(</span><span class="s2">&quot;r2&quot;</span><span class="p">),</span>
        <span class="s2">&quot;d2_poisson&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">d2_tweedie_score</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
        <span class="s2">&quot;d2_gamma&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">d2_tweedie_score</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_pipeline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">hgbr_cv_results</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">collect_cv_predictions</span><span class="p">(</span><span class="n">pipelines</span><span class="p">,</span> <span class="n">cv_splitter</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">prediction_time</span><span class="p">):</span>
    <span class="n">index_generator</span> <span class="o">=</span> <span class="n">cv_splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prediction_time</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">splitter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">index_generator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Workaround to transform a scikit-learn splitter into a function understood</span>
<span class="sd">        by `skrub.train_test_split`.&quot;&quot;&quot;</span>
        <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">index_generator</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">test_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">),</span> <span class="n">pipeline</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">cv_splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prediction_time</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()),</span> <span class="n">pipelines</span>
    <span class="p">):</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
            <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
            <span class="n">index_generator</span><span class="o">=</span><span class="n">index_generator</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;prediction_time&quot;</span><span class="p">:</span> <span class="n">prediction_time</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">()[</span><span class="n">test_idx</span><span class="p">],</span>
                    <span class="s2">&quot;load_mw&quot;</span><span class="p">:</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;y_test&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hgbr_cv_predictions</span> <span class="o">=</span> <span class="n">collect_cv_predictions</span><span class="p">(</span>
    <span class="n">hgbr_cv_results</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">],</span> <span class="n">ts_cv_5</span><span class="p">,</span> <span class="n">hgbr_predictions</span><span class="p">,</span> <span class="n">prediction_time</span>
<span class="p">)</span>
<span class="n">hgbr_cv_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_lorenz_curve</span><span class="p">(</span><span class="n">hgbr_cv_predictions</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_reliability_diagram</span><span class="p">(</span><span class="n">hgbr_cv_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Reliability diagram from cross-validation predictions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_residuals_vs_predicted</span><span class="p">(</span><span class="n">hgbr_cv_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Residuals vs Predicted Values from cross-validation predictions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_binned_residuals</span><span class="p">(</span><span class="n">hgbr_cv_predictions</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Residuals by hour of the day from cross-validation predictions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_binned_residuals</span><span class="p">(</span><span class="n">hgbr_cv_predictions</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Residuals by hour of the day from cross-validation predictions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_cv_2</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span>
    <span class="n">n_splits</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">max_train_size</span><span class="o">=</span><span class="n">max_train_size</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mi">24</span>
<span class="p">)</span>
<span class="n">randomized_search_hgbr</span> <span class="o">=</span> <span class="n">hgbr_predictions</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">get_randomized_search</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_2</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;r2&quot;</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">randomized_search_hgbr</span><span class="o">.</span><span class="n">results_</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">randomized_search_hgbr</span><span class="o">.</span><span class="n">plot_results</span><span class="p">()</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">150</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># nested_cv_results = skrub.cross_validate(</span>
<span class="c1">#     environment=predictions.skb.get_data(),</span>
<span class="c1">#     pipeline=randomized_search,</span>
<span class="c1">#     cv=ts_cv_5,</span>
<span class="c1">#     scoring={</span>
<span class="c1">#         &quot;r2&quot;: get_scorer(&quot;r2&quot;),</span>
<span class="c1">#         &quot;mape&quot;: make_scorer(mean_absolute_percentage_error),</span>
<span class="c1">#     },</span>
<span class="c1">#     n_jobs=-1,</span>
<span class="c1">#     return_pipeline=True,</span>
<span class="c1"># ).round(3)</span>
<span class="c1"># nested_cv_results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for outer_fold_idx in range(len(nested_cv_results)):</span>
<span class="c1">#     print(</span>
<span class="c1">#         nested_cv_results.loc[outer_fold_idx, &quot;pipeline&quot;]</span>
<span class="c1">#         .results_.loc[0]</span>
<span class="c1">#         .round(3)</span>
<span class="c1">#         .to_dict()</span>
<span class="c1">#     )</span>
</pre></div>
</div>
</div>
</div>
<section id="exercise-non-linear-feature-engineering-coupled-with-linear-predictive-model">
<h3>Exercise: non-linear feature engineering coupled with linear predictive model<a class="headerlink" href="#exercise-non-linear-feature-engineering-coupled-with-linear-predictive-model" title="Link to this heading">#</a></h3>
<p>Now, it is your turn to make a predictive model. Towards this end, we request you
to preprocess the input features with non-linear feature engineering:</p>
<ul class="simple">
<li><p>the first step is to impute the missing values using a <code class="docutils literal notranslate"><span class="pre">SimpleImputer</span></code>. Make sure
to include the indicator of missing values in the feature set (i.e. look at the
<code class="docutils literal notranslate"><span class="pre">add_indicator</span></code> parameter);</p></li>
<li><p>use a <code class="docutils literal notranslate"><span class="pre">SplineTransformer</span></code> to create non-linear features. Use the default parameters
but make sure to set <code class="docutils literal notranslate"><span class="pre">sparse_output=True</span></code> since it subsequent processing will be
faster and more memory efficient with such data structure;</p></li>
<li><p>use a <code class="docutils literal notranslate"><span class="pre">VarianceThreshold</span></code> to remove features with potential constant features;</p></li>
<li><p>use a <code class="docutils literal notranslate"><span class="pre">SelectKBest</span></code> to select the most informative features. Set <code class="docutils literal notranslate"><span class="pre">k</span></code> to be chosen
from a log-uniform distribution between 100 and 1,000 (i.e. use <code class="docutils literal notranslate"><span class="pre">skrub.choose_int</span></code>);</p></li>
<li><p>use a <code class="docutils literal notranslate"><span class="pre">Nystroem</span></code> to approximate an RBF kernel. Set <code class="docutils literal notranslate"><span class="pre">n_components</span></code> to be chosen
from a log-uniform distribution between 10 and 200 (i.e. use <code class="docutils literal notranslate"><span class="pre">skrub.choose_int</span></code>).</p></li>
<li><p>finally, use a <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> as the final predictive model. Set <code class="docutils literal notranslate"><span class="pre">alpha</span></code> to be
chosen from a log-uniform distribution between 1e-6 and 1e3 (i.e. use
<code class="docutils literal notranslate"><span class="pre">skrub.choose_float</span></code>).</p></li>
</ul>
<p>Use a scikit-learn <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> using <code class="docutils literal notranslate"><span class="pre">make_pipeline</span></code> to chain the steps together.</p>
<p>Once the predictive model is defined, apply it on the <code class="docutils literal notranslate"><span class="pre">feature_with_dropped_cols</span></code>
expression. Do not forget to define that <code class="docutils literal notranslate"><span class="pre">target</span></code> is the <code class="docutils literal notranslate"><span class="pre">y</span></code> variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here we provide all the imports for creating the predictive model.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelectKBest</span><span class="p">,</span> <span class="n">VarianceThreshold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ridge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.kernel_approximation</span><span class="w"> </span><span class="kn">import</span> <span class="n">Nystroem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">SplineTransformer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Write your code here.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_ridge</span> <span class="o">=</span> <span class="n">features_with_dropped_cols</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">make_pipeline</span><span class="p">(</span>
        <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">add_indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">SplineTransformer</span><span class="p">(</span><span class="n">sparse_output</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">VarianceThreshold</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">),</span>
        <span class="n">SelectKBest</span><span class="p">(</span>
            <span class="n">k</span><span class="o">=</span><span class="n">skrub</span><span class="o">.</span><span class="n">choose_int</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1_000</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;n_selected_splines&quot;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">Nystroem</span><span class="p">(</span>
            <span class="n">n_components</span><span class="o">=</span><span class="n">skrub</span><span class="o">.</span><span class="n">choose_int</span><span class="p">(</span>
                <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;n_components&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">150</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">Ridge</span><span class="p">(</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">skrub</span><span class="o">.</span><span class="n">choose_float</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">predictions_ridge</span>
</pre></div>
</div>
</div>
</div>
<p>Now that you defined the predictive model, let’s make a similar analysis than earlier.
First, let’s make a sanity check that plot forecast of our model on a subset of the
training data to make a sanity check.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Write your code here.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">targets</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
            <span class="n">predictions_ridge</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="p">{</span><span class="n">target_column_name</span><span class="p">:</span> <span class="n">predicted_target_column_name</span><span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
        <span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">transform_fold</span><span class="p">(</span>
    <span class="p">[</span><span class="n">target_column_name</span><span class="p">,</span> <span class="n">predicted_target_column_name</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;prediction_time:T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value:Q&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;key:N&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s evaluate the performance of the model using cross-validation. Use the
time-based cross-validation splitter <code class="docutils literal notranslate"><span class="pre">ts_cv_5</span></code> defined earlier. Make sure to compute
the R2 score and the mean absolute percentage error. Return the training scores as
well as the fitted pipeline such that we can make additional analysis.</p>
<p>Does this model perform better or worse than the previous model?
Is it underfitting or overfitting?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Write your code here.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv_results_ridge</span> <span class="o">=</span> <span class="n">predictions_ridge</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_5</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="n">get_scorer</span><span class="p">(</span><span class="s2">&quot;r2&quot;</span><span class="p">),</span>
        <span class="s2">&quot;mape&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">mean_absolute_percentage_error</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_pipeline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Call all cross-validated predictions to plot the Lorenz curve and the reliability
diagram. Call the function <code class="docutils literal notranslate"><span class="pre">collect_cv_predictions</span></code> to collect the predictions and
then call the <code class="docutils literal notranslate"><span class="pre">plot_lorenz_curve</span></code> and <code class="docutils literal notranslate"><span class="pre">plot_reliability_diagram</span></code> functions to plot
the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Write your code here.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv_predictions_ridge</span> <span class="o">=</span> <span class="n">collect_cv_predictions</span><span class="p">(</span>
    <span class="n">cv_results_ridge</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">],</span> <span class="n">ts_cv_5</span><span class="p">,</span> <span class="n">predictions_ridge</span><span class="p">,</span> <span class="n">prediction_time</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_lorenz_curve</span><span class="p">(</span><span class="n">cv_predictions_ridge</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_reliability_diagram</span><span class="p">(</span><span class="n">cv_predictions_ridge</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Reliability diagram from cross-validation predictions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, you can perform a randomized search on the hyper-parameters of the model.
Use the <code class="docutils literal notranslate"><span class="pre">ts_cv_2</span></code> splitter defined earlier. This search is quite computationally
expensive, so feel free to reduce the number of iterations but doing at least 100
iterations is nice to have an overview of the impact of the hyper-parameters.
Use <code class="docutils literal notranslate"><span class="pre">plot_results</span></code> to show the parallel coordinates plot of the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Write your code here.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">randomized_search_ridge</span> <span class="o">=</span> <span class="n">predictions_ridge</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">get_randomized_search</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_2</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;r2&quot;</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">randomized_search_ridge</span><span class="o">.</span><span class="n">plot_results</span><span class="p">()</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">200</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We observe that the default values of the hyper-parameters are in the optimal
region explored by the randomized search. This is a good sign that the model
is well-specified and that the hyper-parameters are not too sensitive to
small changes of those values.</p>
<p>We could further assess the stability of those optimal hyper-parameters by
running a nested cross-validation, where we would perform a randomized search
for each fold of the outer cross-validation loop as below but this is
computationally expensive.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># nested_cv_results_ridge = skrub.cross_validate(</span>
<span class="c1">#     environment=predictions_ridge.skb.get_data(),</span>
<span class="c1">#     pipeline=randomized_search_ridge,</span>
<span class="c1">#     cv=ts_cv_5,</span>
<span class="c1">#     scoring={</span>
<span class="c1">#         &quot;r2&quot;: get_scorer(&quot;r2&quot;),</span>
<span class="c1">#         &quot;mape&quot;: make_scorer(mean_absolute_percentage_error),</span>
<span class="c1">#     },</span>
<span class="c1">#     n_jobs=-1,</span>
<span class="c1">#     return_pipeline=True,</span>
<span class="c1"># ).round(3)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># nested_cv_results_ridge.round(3)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="predicting-multiple-horizons-with-a-multi-output-model">
<h2>Predicting multiple horizons with a multi-output model<a class="headerlink" href="#predicting-multiple-horizons-with-a-multi-output-model" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.multioutput</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiOutputRegressor</span>

<span class="n">multioutput_predictions</span> <span class="o">=</span> <span class="n">features_with_dropped_cols</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">MultiOutputRegressor</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">HistGradientBoostingRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">targets</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span> <span class="s2">&quot;load_mw&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">mark_as_y</span><span class="p">(),</span>
<span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;multioutput_gbdt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_column_name_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">horizons</span><span class="p">]</span>
<span class="n">predicted_target_column_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;predicted_</span><span class="si">{</span><span class="n">target_column_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">target_column_name</span> <span class="ow">in</span> <span class="n">target_column_names</span>
<span class="p">]</span>
<span class="n">named_predictions</span> <span class="o">=</span> <span class="n">multioutput_predictions</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_column_names</span><span class="p">,</span> <span class="n">predicted_target_column_names</span><span class="p">)}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_at_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<span class="n">historical_timedelta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plot_horizon_forecast</span><span class="p">(</span>
    <span class="n">targets</span><span class="p">,</span>
    <span class="n">named_predictions</span><span class="p">,</span>
    <span class="n">plot_at_time</span><span class="p">,</span>
    <span class="n">historical_timedelta</span><span class="p">,</span>
    <span class="n">target_column_name_pattern</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_at_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<span class="n">plot_horizon_forecast</span><span class="p">(</span>
    <span class="n">targets</span><span class="p">,</span>
    <span class="n">named_predictions</span><span class="p">,</span>
    <span class="n">plot_at_time</span><span class="p">,</span>
    <span class="n">historical_timedelta</span><span class="p">,</span>
    <span class="n">target_column_name_pattern</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span>


<span class="k">def</span><span class="w"> </span><span class="nf">multioutput_scorer</span><span class="p">(</span><span class="n">regressor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">score_func</span><span class="p">,</span> <span class="n">score_name</span><span class="p">):</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score_name</span><span class="si">}</span><span class="s2">_horizon_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">h&quot;</span><span class="p">:</span> <span class="n">score</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="n">score_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">multioutput</span><span class="o">=</span><span class="s2">&quot;raw_values&quot;</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">scoring</span><span class="p">(</span><span class="n">regressor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">multioutput_scorer</span><span class="p">(</span><span class="n">regressor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span><span class="p">,</span> <span class="s2">&quot;mape&quot;</span><span class="p">),</span>
        <span class="o">**</span><span class="n">multioutput_scorer</span><span class="p">(</span><span class="n">regressor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">),</span>
    <span class="p">}</span>


<span class="n">multioutput_cv_results</span> <span class="o">=</span> <span class="n">multioutput_predictions</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_5</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span>
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multioutput_cv_results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">dataset_type</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="s2">&quot;mape&quot;</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">multioutput_cv_results</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
        <span class="n">multioutput_cv_results</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">multioutput_cv_results</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">data_to_plot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_type</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span>
    <span class="p">]</span>

    <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;horizon&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
    <span class="n">chart</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span>
            <span class="n">data_long</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_type</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Scores by Horizon&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">mark_boxplot</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="s2">&quot;min-max&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">X</span><span class="p">(</span>
                <span class="s2">&quot;horizon:N&quot;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Horizon&quot;</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">Sort</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;horizon </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">h&quot;</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">y</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s2">&quot;score:Q&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Score&quot;</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;horizon:N&quot;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">display</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: Exercise using RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="n">multioutput_predictions_rf</span> <span class="o">=</span> <span class="n">features_with_dropped_cols</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">targets</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span> <span class="s2">&quot;load_mw&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">mark_as_y</span><span class="p">(),</span>
<span class="p">)</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;random_forest&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">named_predictions_rf</span> <span class="o">=</span> <span class="n">multioutput_predictions_rf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_column_names</span><span class="p">,</span> <span class="n">predicted_target_column_names</span><span class="p">)}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_at_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<span class="n">historical_timedelta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plot_horizon_forecast</span><span class="p">(</span>
    <span class="n">targets</span><span class="p">,</span>
    <span class="n">named_predictions_rf</span><span class="p">,</span>
    <span class="n">plot_at_time</span><span class="p">,</span>
    <span class="n">historical_timedelta</span><span class="p">,</span>
    <span class="n">target_column_name_pattern</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_at_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<span class="n">plot_horizon_forecast</span><span class="p">(</span>
    <span class="n">targets</span><span class="p">,</span>
    <span class="n">named_predictions_rf</span><span class="p">,</span>
    <span class="n">plot_at_time</span><span class="p">,</span>
    <span class="n">historical_timedelta</span><span class="p">,</span>
    <span class="n">target_column_name_pattern</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multioutput_cv_results_rf</span> <span class="o">=</span> <span class="n">multioutput_predictions_rf</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_5</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span>
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multioutput_cv_results_rf</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">dataset_type</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="s2">&quot;mape&quot;</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">multioutput_cv_results_rf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
        <span class="n">multioutput_cv_results</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">multioutput_cv_results_rf</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">data_to_plot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_type</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span>
    <span class="p">]</span>

    <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;horizon&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
    <span class="n">chart</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span>
            <span class="n">data_long</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_type</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Scores by Horizon&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">mark_boxplot</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="s2">&quot;min-max&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">X</span><span class="p">(</span>
                <span class="s2">&quot;horizon:N&quot;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Horizon&quot;</span><span class="p">,</span>
                <span class="n">sort</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">Sort</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;horizon </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">h&quot;</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">y</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s2">&quot;score:Q&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Score&quot;</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;horizon:N&quot;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">display</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">d2_pinball_score</span>

<span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="n">get_scorer</span><span class="p">(</span><span class="s2">&quot;r2&quot;</span><span class="p">),</span>
    <span class="s2">&quot;mape&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">mean_absolute_percentage_error</span><span class="p">),</span>
    <span class="s2">&quot;d2_pinball_05_loss&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">d2_pinball_score</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">),</span>
    <span class="s2">&quot;d2_pinball_50_loss&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">d2_pinball_score</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="s2">&quot;d2_pinball_95_loss&quot;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">d2_pinball_score</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">common_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_leaf_nodes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
<span class="n">predictions_hgbr_05</span> <span class="o">=</span> <span class="n">features_with_dropped_cols</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">common_params</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.05</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">predictions_hgbr_50</span> <span class="o">=</span> <span class="n">features_with_dropped_cols</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">common_params</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">predictions_hgbr_95</span> <span class="o">=</span> <span class="n">features_with_dropped_cols</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">common_params</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.95</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv_results_hgbr_05</span> <span class="o">=</span> <span class="n">predictions_hgbr_05</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_5</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span>
    <span class="n">return_pipeline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cv_results_hgbr_50</span> <span class="o">=</span> <span class="n">predictions_hgbr_50</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_5</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span>
    <span class="n">return_pipeline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cv_results_hgbr_95</span> <span class="o">=</span> <span class="n">predictions_hgbr_95</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">ts_cv_5</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span>
    <span class="n">return_pipeline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv_results_hgbr_05</span><span class="p">[</span>
    <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cv_results_hgbr_05</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)]</span>
<span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv_results_hgbr_50</span><span class="p">[</span>
    <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cv_results_hgbr_50</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)]</span>
<span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv_results_hgbr_95</span><span class="p">[</span>
    <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cv_results_hgbr_95</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_&quot;</span><span class="p">)]</span>
<span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">targets</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prediction_time&quot;</span><span class="p">,</span> <span class="n">target_column_name</span><span class="p">])</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
        <span class="n">predictions_hgbr_05</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">target_column_name</span><span class="p">:</span> <span class="s2">&quot;quantile_05&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
        <span class="n">predictions_hgbr_50</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">target_column_name</span><span class="p">:</span> <span class="s2">&quot;median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
        <span class="n">predictions_hgbr_95</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">target_column_name</span><span class="p">:</span> <span class="s2">&quot;quantile_95&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">skb</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
    <span class="p">],</span>
    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">median_chart</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transform_fold</span><span class="p">([</span><span class="n">target_column_name</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">mark_line</span><span class="p">(</span><span class="n">tooltip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;prediction_time:T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value:Q&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;key:N&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">quantile_band_chart</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mark_area</span><span class="p">(</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;prediction_time:T&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;quantile_05:Q&quot;</span><span class="p">,</span>
        <span class="n">y2</span><span class="o">=</span><span class="s2">&quot;quantile_95:Q&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">altair</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;lightgreen&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">combined_chart</span> <span class="o">=</span> <span class="n">quantile_band_chart</span> <span class="o">+</span> <span class="n">median_chart</span>
<span class="n">combined_chart</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv_predictions_hgbr_05</span> <span class="o">=</span> <span class="n">collect_cv_predictions</span><span class="p">(</span>
    <span class="n">cv_results_hgbr_05</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">],</span> <span class="n">ts_cv_5</span><span class="p">,</span> <span class="n">predictions_hgbr_05</span><span class="p">,</span> <span class="n">prediction_time</span>
<span class="p">)</span>
<span class="n">cv_predictions_hgbr_50</span> <span class="o">=</span> <span class="n">collect_cv_predictions</span><span class="p">(</span>
    <span class="n">cv_results_hgbr_50</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">],</span> <span class="n">ts_cv_5</span><span class="p">,</span> <span class="n">predictions_hgbr_50</span><span class="p">,</span> <span class="n">prediction_time</span>
<span class="p">)</span>
<span class="n">cv_predictions_hgbr_95</span> <span class="o">=</span> <span class="n">collect_cv_predictions</span><span class="p">(</span>
    <span class="n">cv_results_hgbr_95</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">],</span> <span class="n">ts_cv_5</span><span class="p">,</span> <span class="n">predictions_hgbr_95</span><span class="p">,</span> <span class="n">prediction_time</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_residuals_vs_predicted</span><span class="p">(</span><span class="n">cv_predictions_hgbr_05</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;Residuals vs Predicted Values from cross-validation predictions&quot;</span>
        <span class="s2">&quot; for quantile 0.05&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_residuals_vs_predicted</span><span class="p">(</span><span class="n">cv_predictions_hgbr_50</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;Residuals vs Predicted Values from cross-validation predictions&quot;</span> <span class="s2">&quot; for median&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_residuals_vs_predicted</span><span class="p">(</span><span class="n">cv_predictions_hgbr_95</span><span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;Residuals vs Predicted Values from cross-validation predictions&quot;</span>
        <span class="s2">&quot; for quantile 0.95&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv_predictions_hgbr_05_concat</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cv_predictions_hgbr_05</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">cv_predictions_hgbr_50_concat</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cv_predictions_hgbr_50</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">cv_predictions_hgbr_95_concat</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cv_predictions_hgbr_95</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">PredictionErrorDisplay</span>


<span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;actual_vs_predicted&quot;</span><span class="p">,</span> <span class="s2">&quot;residual_vs_predicted&quot;</span><span class="p">]:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">PredictionErrorDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">cv_predictions_hgbr_05_concat</span><span class="p">[</span><span class="s2">&quot;load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">cv_predictions_hgbr_05_concat</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;0.05 quantile regression&quot;</span><span class="p">)</span>

    <span class="n">PredictionErrorDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">cv_predictions_hgbr_50_concat</span><span class="p">[</span><span class="s2">&quot;load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">cv_predictions_hgbr_50_concat</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Median regression&quot;</span><span class="p">)</span>

    <span class="n">PredictionErrorDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">cv_predictions_hgbr_95_concat</span><span class="p">[</span><span class="s2">&quot;load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">cv_predictions_hgbr_95_concat</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;0.95 quantile regression&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2"> for GBRT minimzing different quantile losses&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">coverage</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_quantile_low</span><span class="p">,</span> <span class="n">y_quantile_high</span><span class="p">):</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">y_quantile_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_quantile_low</span><span class="p">)</span>
    <span class="n">y_quantile_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_quantile_high</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">y_true</span> <span class="o">&gt;=</span> <span class="n">y_quantile_low</span><span class="p">,</span> <span class="n">y_true</span> <span class="o">&lt;=</span> <span class="n">y_quantile_high</span><span class="p">)</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">mean_width</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_quantile_low</span><span class="p">,</span> <span class="n">y_quantile_high</span><span class="p">):</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">y_quantile_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_quantile_low</span><span class="p">)</span>
    <span class="n">y_quantile_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_quantile_high</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_quantile_high</span> <span class="o">-</span> <span class="n">y_quantile_low</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">binned_coverage</span><span class="p">(</span><span class="n">y_true_folds</span><span class="p">,</span> <span class="n">y_quantile_low</span><span class="p">,</span> <span class="n">y_quantile_high</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute coverage after binning true values using quantile-based binning.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y_true_folds : list of numpy.ndarray</span>
<span class="sd">        List of true target values, one array per CV fold</span>
<span class="sd">    y_quantile_low : list of numpy.ndarray</span>
<span class="sd">        List of lower quantile predictions, one array per CV fold</span>
<span class="sd">    y_quantile_high : list of numpy.ndarray</span>
<span class="sd">        List of upper quantile predictions, one array per CV fold</span>
<span class="sd">    n_bins : int, default=10</span>
<span class="sd">        Number of bins to create</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame with columns: bin_left, bin_right, bin_center, fold_idx,</span>
<span class="sd">        coverage, mean_width, n_samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use all true values to define global bin boundaries</span>
    <span class="n">all_true_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_true_folds</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;bin_by&quot;</span><span class="p">:</span> <span class="n">all_true_values</span><span class="p">})</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;bin_by&quot;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>

    <span class="c1"># Get bin boundaries for consistent binning across folds</span>
    <span class="n">bin_boundaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
        <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_idx</span>
        <span class="n">bin_values</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">,</span> <span class="s2">&quot;bin_by&quot;</span><span class="p">]</span>
        <span class="n">bin_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bin_values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bin_values</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_folds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_quantile_low</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fold_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_folds</span><span class="p">):</span>
        <span class="n">fold_true</span> <span class="o">=</span> <span class="n">y_true_folds</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>
        <span class="n">fold_low</span> <span class="o">=</span> <span class="n">y_quantile_low</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>
        <span class="n">fold_high</span> <span class="o">=</span> <span class="n">y_quantile_high</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>

        <span class="c1"># Assign each sample in this fold to a bin</span>
        <span class="n">fold_bins</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">fold_true</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bin_boundaries</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">bin_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">bin_left</span><span class="p">,</span> <span class="n">bin_right</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bin_boundaries</span><span class="p">):</span>
            <span class="c1"># Get samples from this fold that fall into this bin</span>
            <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">fold_bins</span> <span class="o">==</span> <span class="n">bin_idx</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># No samples in this bin for this fold</span>
                <span class="k">continue</span>

            <span class="n">fold_bin_true</span> <span class="o">=</span> <span class="n">fold_true</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span>
            <span class="n">fold_bin_low</span> <span class="o">=</span> <span class="n">fold_low</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span>
            <span class="n">fold_bin_high</span> <span class="o">=</span> <span class="n">fold_high</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span>

            <span class="n">bin_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_left</span> <span class="o">+</span> <span class="n">bin_right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">n_samples_in_bin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold_bin_true</span><span class="p">)</span>

            <span class="n">coverage_score</span> <span class="o">=</span> <span class="n">coverage</span><span class="p">(</span><span class="n">fold_bin_true</span><span class="p">,</span> <span class="n">fold_bin_low</span><span class="p">,</span> <span class="n">fold_bin_high</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">mean_width</span><span class="p">(</span><span class="n">fold_bin_true</span><span class="p">,</span> <span class="n">fold_bin_low</span><span class="p">,</span> <span class="n">fold_bin_high</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;bin_left&quot;</span><span class="p">:</span> <span class="n">bin_left</span><span class="p">,</span>
                    <span class="s2">&quot;bin_right&quot;</span><span class="p">:</span> <span class="n">bin_right</span><span class="p">,</span>
                    <span class="s2">&quot;bin_center&quot;</span><span class="p">:</span> <span class="n">bin_center</span><span class="p">,</span>
                    <span class="s2">&quot;fold_idx&quot;</span><span class="p">:</span> <span class="n">fold_idx</span><span class="p">,</span>
                    <span class="s2">&quot;coverage&quot;</span><span class="p">:</span> <span class="n">coverage_score</span><span class="p">,</span>
                    <span class="s2">&quot;mean_width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
                    <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="n">n_samples_in_bin</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coverage</span><span class="p">(</span>
    <span class="n">cv_predictions_hgbr_50_concat</span><span class="p">[</span><span class="s2">&quot;load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="n">cv_predictions_hgbr_05_concat</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="n">cv_predictions_hgbr_95_concat</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">mean_width</span><span class="p">(</span>
    <span class="n">cv_predictions_hgbr_50_concat</span><span class="p">[</span><span class="s2">&quot;load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="n">cv_predictions_hgbr_05_concat</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="n">cv_predictions_hgbr_95_concat</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
<span class="p">)</span>

<span class="c1"># Compute binned coverage scores</span>
<span class="n">binned_coverage_results</span> <span class="o">=</span> <span class="n">binned_coverage</span><span class="p">(</span>
    <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">cv_predictions_hgbr_50</span><span class="p">],</span>
    <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">cv_predictions_hgbr_05</span><span class="p">],</span>
    <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;predicted_load_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">cv_predictions_hgbr_95</span><span class="p">],</span>
    <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">binned_coverage_results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coverage_by_bin</span> <span class="o">=</span> <span class="n">binned_coverage_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">coverage_by_bin</span><span class="p">[</span><span class="s2">&quot;bin_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coverage_by_bin</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">bin_left</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">bin_right</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">coverage_by_bin</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
    <span class="n">column</span><span class="o">=</span><span class="s2">&quot;coverage&quot;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;bin_label&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">whis</span><span class="o">=</span><span class="mi">1000</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target coverage (0.9)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Load bins (MW)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Coverage&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Coverage Distribution by Load Bins&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Remove automatic suptitle from boxplot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="reliability-diagram-for-quantile-regression">
<h2>Reliability diagram for quantile regression<a class="headerlink" href="#reliability-diagram-for-quantile-regression" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_reliability_diagram</span><span class="p">(</span>
    <span class="n">cv_predictions_hgbr_50</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile_level</span><span class="o">=</span><span class="mf">0.50</span>
<span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Reliability diagram for quantile 0.50 from cross-validation predictions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_reliability_diagram</span><span class="p">(</span>
    <span class="n">cv_predictions_hgbr_05</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile_level</span><span class="o">=</span><span class="mf">0.05</span>
<span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Reliability diagram for quantile 0.05 from cross-validation predictions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_reliability_diagram</span><span class="p">(</span>
    <span class="n">cv_predictions_hgbr_95</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile_level</span><span class="o">=</span><span class="mf">0.95</span>
<span class="p">)</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Reliability diagram for quantile 0.95 from cross-validation predictions&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="quantile-regression-as-classification">
<h2>Quantile regression as classification<a class="headerlink" href="#quantile-regression-as-classification" title="Link to this heading">#</a></h2>
<p>In the following, we turn a quantile regression problem for all possible
quantile levels into a multiclass classification problem by discretizing the
target variable into bins and interpolating the cumulative sum of the bin
membership probability to estimate the CDF of the distribution of the
continuous target variable conditioned on the features.</p>
<p>Ideally, the classifier should be efficient when trained on a large number of
classes (induced by the number of bins). Therefore we use a Random Forest
classifier as the default base estimator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">,</span> <span class="n">clone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_is_fitted</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">KBinsDiscretizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_consistent_length</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_random_state</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BinnedQuantileRegressor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">estimator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">quantile</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">estimator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantile</span> <span class="o">=</span> <span class="n">quantile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Lightweight input validation: most of the input validation will be</span>
        <span class="c1"># handled by the sub estimators.</span>
        <span class="n">random_state</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">check_consistent_length</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_binner_</span> <span class="o">=</span> <span class="n">KBinsDiscretizer</span><span class="p">(</span>
            <span class="n">n_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
            <span class="n">subsample</span><span class="o">=</span><span class="mi">200_000</span><span class="p">,</span>
            <span class="n">encode</span><span class="o">=</span><span class="s2">&quot;ordinal&quot;</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">y_binned</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_binner_</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Fit the multiclass classifier to predict the binned targets from the</span>
        <span class="c1"># training set.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">estimator</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">estimator</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimator_</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_binned</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_quantiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)):</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;estimator_&quot;</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_binner_</span><span class="o">.</span><span class="n">bin_edges_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_bins</span><span class="p">)</span>
        <span class="n">y_proba_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Some might stay empty on the training set. Typically, classifiers do</span>
        <span class="c1"># not learn to predict an explicit 0 probability for unobserved classes</span>
        <span class="c1"># so we have to post process their output:</span>
        <span class="k">if</span> <span class="n">y_proba_raw</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">expected_shape</span><span class="p">:</span>
            <span class="n">y_proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">expected_shape</span><span class="p">)</span>
            <span class="n">y_proba</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">classes_</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_proba_raw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_proba_raw</span>

        <span class="c1"># Build the mapper for inverse CDF mapping, from cumulated</span>
        <span class="c1"># probabilities to continuous prediction.</span>
        <span class="n">y_cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">y_cdf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">y_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">interp1d</span><span class="p">(</span><span class="n">y_cdf_i</span><span class="p">,</span> <span class="n">edges</span><span class="p">)(</span><span class="n">quantiles</span><span class="p">)</span> <span class="k">for</span> <span class="n">y_cdf_i</span> <span class="ow">in</span> <span class="n">y_cdf</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_quantiles</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantile</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="fetch_weather_data.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Historical weather data download from open-meteo.com</p>
      </div>
    </a>
    <a class="right-next"
       href="direct_vs_recursive_forecasting.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Direct vs Recursive Forecasting</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shared-time-range-for-all-historical-data-sources">Shared time range for all historical data sources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calendar-and-holidays-features">Calendar and holidays features</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#electricity-load-data">Electricity load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lagged-features">Lagged features</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remark-lagged-features-engineering-and-system-lag">Remark lagged features engineering and system lag</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#investigating-outliers-in-the-lagged-features">Investigating outliers in the lagged features</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-dataset">Final dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-the-model-performance-via-cross-validation">Assessing the model performance via cross-validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-non-linear-feature-engineering-coupled-with-linear-predictive-model">Exercise: non-linear feature engineering coupled with linear predictive model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#predicting-multiple-horizons-with-a-multi-output-model">Predicting multiple horizons with a multi-output model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reliability-diagram-for-quantile-regression">Reliability diagram for quantile regression</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantile-regression-as-classification">Quantile regression as classification</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Guillaume Lemaitre & Olivier Grisel
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>